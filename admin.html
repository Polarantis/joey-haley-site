<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Gallery Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #0b0b0b;
      --fg: #f3f3f3;
      --muted: #888;
      --edge: #333;
      --accent: #2563eb;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font: 16px/1.4 -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    /* Login Form */
    .login {
      background: #111;
      border: 1px solid var(--edge);
      border-radius: 12px;
      padding: 30px;
      margin-top: 50px;
      text-align: center;
    }

    .login h1 {
      margin: 0 0 20px 0;
      font-size: 24px;
    }

    input[type="password"] {
      width: 100%;
      padding: 16px;
      border: 1px solid var(--edge);
      border-radius: 8px;
      background: var(--bg);
      color: var(--fg);
      font-size: 16px;
      margin-bottom: 16px;
    }

    .btn {
      width: 100%;
      padding: 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }

    .btn:disabled {
      opacity: 0.5;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--edge);
      color: var(--fg);
    }

    /* Admin Interface */
    .admin {
      display: none;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--edge);
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
    }

    .actions {
      display: flex;
      gap: 10px;
    }

    .actions .btn {
      width: auto;
      padding: 8px 16px;
      font-size: 14px;
    }

    /* Gallery List */
    .gallery-list {
      background: #111;
      border: 1px solid var(--edge);
      border-radius: 12px;
      overflow: hidden;
    }

    .gallery-header {
      padding: 20px;
      border-bottom: 1px solid var(--edge);
      text-align: center;
    }

    .gallery-header h2 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }

    .gallery-header p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .image-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      border-bottom: 1px solid var(--edge);
      background: #111;
    }

    .image-item:last-child {
      border-bottom: none;
    }

    .image-item.dragging {
      opacity: 0.5;
    }

    .drag-handle {
      color: var(--muted);
      cursor: grab;
      font-size: 18px;
      padding: 4px;
    }

    .drag-handle:active {
      cursor: grabbing;
    }

    .image-preview {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      background: #222;
    }

    .image-info {
      flex: 1;
      min-width: 0;
    }

    .image-name {
      font-weight: 500;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .image-meta {
      color: var(--muted);
      font-size: 14px;
    }

    .image-controls {
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border: 1px solid var(--edge);
      background: transparent;
      color: var(--fg);
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-small:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .btn-small.danger {
      color: #ff6b6b;
      border-color: #ff6b6b;
    }

    /* Status Messages */
    .status {
      padding: 16px;
      margin: 16px 0;
      border-radius: 8px;
      text-align: center;
    }

    .status.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #4ade80;
    }

    .status.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #f87171;
    }

    .status.info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #60a5fa;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }

    .empty {
      text-align: center;
      padding: 40px;
      color: var(--muted);
      font-style: italic;
    }

    .login-form h1 {
      margin: 0 0 var(--grid) 0;
      text-align: center;
    }

    .form-group {
      margin-bottom: var(--grid);
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--muted);
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--edge);
      border-radius: 10px;
      background: var(--bg);
      color: var(--fg);
      font-size: 16px;
    }

    .form-group input:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 16px 24px; /* Larger touch target */
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      transition: all 0.2s ease;
      min-height: 48px; /* Touch-friendly */
    }

    .btn:hover {
      background: #1d4ed8;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: calc(var(--grid) * 2);
      padding-bottom: var(--grid);
      border-bottom: 1px solid var(--edge);
    }

    .admin-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--edge);
      color: var(--fg);
      padding: 12px 16px; /* Larger touch target */
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 44px; /* Touch-friendly */
    }

    .btn-secondary:hover {
      border-color: #2a2a2a;
      background: rgba(255, 255, 255, 0.05);
    }

    .gallery-manager {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--grid);
      margin-bottom: calc(var(--grid) * 2);
    }

    /* Mobile-first design */
    @media (min-width: 768px) {
      .gallery-manager {
        grid-template-columns: 1fr 200px 1fr;
        gap: calc(var(--grid) * 1.5);
      }
    }

    @media (min-width: 1200px) {
      .gallery-manager {
        grid-template-columns: 2fr 1fr 2fr;
        gap: calc(var(--grid) * 1.5);
      }
    }

    .panel {
      border: 1px solid var(--edge);
      border-radius: 18px;
      background: var(--bg);
      overflow: hidden;
    }

    .panel-header {
      padding: var(--grid);
      border-bottom: 1px solid var(--edge);
      background: #101010;
    }

    .panel-header h2 {
      margin: 0;
      font-size: 18px;
    }

    .panel-content {
      padding: calc(var(--grid) / 2);
      max-height: 400px;
      overflow-y: auto;
    }

    @media (min-width: 768px) {
      .panel-content {
        padding: var(--grid);
        max-height: 600px;
      }
    }

    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
    }

    @media (min-width: 768px) {
      .image-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
      }
    }

    .image-item {
      position: relative;
      aspect-ratio: 1;
      border: 2px solid transparent;
      border-radius: 10px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #101010;
      min-height: 44px; /* Touch-friendly minimum */
    }

    .image-item:hover {
      border-color: var(--accent);
    }

    .image-item.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3);
    }

    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .image-item .overlay {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
    }

    .ordered-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .ordered-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      border: 1px solid var(--edge);
      border-radius: 8px;
      background: #101010;
    }

    .ordered-item img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 6px;
    }

    .ordered-item .info {
      flex: 1;
      font-size: 14px;
    }

    .ordered-item .actions {
      display: flex;
      gap: 4px;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
      border: 1px solid var(--edge);
      background: transparent;
      color: var(--fg);
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-small:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .status {
      padding: 12px;
      margin: 12px 0;
      border-radius: 8px;
      font-size: 14px;
    }

    .status.success {
      background: rgba(22, 163, 74, 0.1);
      border: 1px solid rgba(22, 163, 74, 0.3);
      color: #4ade80;
    }

    .status.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #f87171;
    }

    .status.info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #60a5fa;
    }

    .loading {
      text-align: center;
      padding: calc(var(--grid) * 2);
      color: var(--muted);
    }

    .drag-handle {
      cursor: grab;
      padding: 4px;
      color: var(--muted);
    }

    .drag-handle:active {
      cursor: grabbing;
    }

    .ordered-item.dragging {
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Form -->
    <div id="loginForm" class="login">
      <h1>üîê Gallery Admin</h1>
      <form id="authForm">
        <input type="password" id="password" placeholder="Enter password" required>
        <button type="submit" class="btn">Login</button>
      </form>
      <div id="loginStatus"></div>
    </div>

    <!-- Admin Interface -->
    <div id="adminInterface" class="admin">
      <div class="header">
        <h1>üì∏ Gallery</h1>
        <div class="actions">
          <button id="saveBtn" class="btn">üíæ Save</button>
          <button id="logoutBtn" class="btn btn-ghost">Logout</button>
        </div>
      </div>

      <div id="statusMessage"></div>

      <div class="gallery-list">
        <div class="gallery-header">
          <h2>Drag to Reorder Gallery</h2>
          <p>First 9 images appear as featured on homepage</p>
        </div>
        <div id="galleryImages" class="loading">Loading gallery...</div>
      </div>
    </div>
  </div>

  <script>
    // Simple state
    let galleryOrder = [];
    let isAuthenticated = false;
    let draggedIndex = null;

    // DOM Elements
    const loginForm = document.getElementById('loginForm');
    const adminInterface = document.getElementById('adminInterface');
    const authForm = document.getElementById('authForm');
    const loginStatus = document.getElementById('loginStatus');
    const statusMessage = document.getElementById('statusMessage');
    const galleryContainer = document.getElementById('galleryImages');

    // Utility functions
    function showStatus(message, type = 'info') {
      statusMessage.innerHTML = `<div class="status ${type}">${message}</div>`;
      setTimeout(() => statusMessage.innerHTML = '', 4000);
    }

    function showLoginStatus(message, type = 'error') {
      loginStatus.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    // Authentication
    function checkAuth() {
      const stored = localStorage.getItem(ADMIN_PASSWORD_KEY);
      if (stored) {
        isAuthenticated = true;
        showAdminInterface();
      }
    }

    async function authenticate(password) {
      try {
        // For production, check against Cloudflare environment variable via API
        const response = await fetch('/api/admin/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });

        if (response.ok) {
          localStorage.setItem(ADMIN_PASSWORD_KEY, 'authenticated');
          isAuthenticated = true;
          showAdminInterface();
          return true;
        }
        return false;
      } catch (error) {
        // Fallback for local development
        console.warn('Using fallback authentication for local development');
        if (password === 'joeyhaley2024') {
          localStorage.setItem(ADMIN_PASSWORD_KEY, 'authenticated');
          isAuthenticated = true;
          showAdminInterface();
          return true;
        }
        return false;
      }
    }

    function logout() {
      localStorage.removeItem(ADMIN_PASSWORD_KEY);
      isAuthenticated = false;
      adminInterface.style.display = 'none';
      loginForm.style.display = 'block';
    }

    function showAdminInterface() {
      loginForm.style.display = 'none';
      adminInterface.style.display = 'block';
      loadGalleryData();
    }

    // Gallery management
    async function loadGalleryData() {
      try {
        showStatus('Loading gallery data...', 'info');
        
        // Load current gallery data
        const response = await fetch('/api/gallery');
        if (!response.ok) {
          throw new Error(`API returned ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('API Response:', response.status);
        console.log('Loaded gallery data:', data);
        console.log('Featured images:', data.featured?.length || 0);
        console.log('All images:', data.all?.length || 0);
        
        allImages = data.all || [];
        
        // If no images at all, show error
        if (!allImages.length) {
          showStatus('No images found in R2 bucket', 'error');
          return;
        }

        // Load saved configuration from localStorage
        const savedConfig = localStorage.getItem('gallery_admin_config');
        if (savedConfig) {
          try {
            const config = JSON.parse(savedConfig);
            vetoedImages = config.vetoed || [];
            orderedImages = config.ordered || [];
            
            // Validate that ordered images still exist in allImages
            orderedImages = orderedImages.filter(orderedImg => 
              allImages.some(img => img.key === orderedImg.key)
            );
            
            // Validate that vetoed images still exist in allImages
            vetoedImages = vetoedImages.filter(vetoedImg => 
              allImages.some(img => img.key === vetoedImg.key)
            );
          } catch (e) {
            console.error('Invalid config, resetting:', e);
            localStorage.removeItem('gallery_admin_config');
            vetoedImages = [];
            orderedImages = [];
          }
        } else {
          // Default: empty arrays, all images available
          vetoedImages = [];
          orderedImages = [];
        }        renderAllImages();
        renderOrderedImages();
        renderVetoedImages();
        updateCounts();
        showStatus('Gallery data loaded successfully', 'success');
        
      } catch (error) {
        console.error('Failed to load gallery:', error);
        showStatus('Failed to load gallery data', 'error');
      }
    }

    function renderAllImages() {
      console.log('Rendering all images, total:', allImages.length); // Debug
      
      if (!allImages.length) {
        allImagesContainer.innerHTML = '<div class="loading">No images found in R2 bucket</div>';
        return;
      }

      const grid = document.createElement('div');
      grid.className = 'image-grid';

      // Show images that aren't in gallery or vetoed
      const availableImages = allImages.filter(img => 
        !orderedImages.some(ordered => ordered.key === img.key) &&
        !vetoedImages.some(vetoed => vetoed.key === img.key)
      );

      console.log('Available images (not in gallery/vetoed):', availableImages.length); // Debug

      if (availableImages.length === 0) {
        allImagesContainer.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">All images are either in gallery or vetoed</div>';
        return;
      }

      availableImages.forEach((image, index) => {
        const item = document.createElement('div');
        item.className = 'image-item';
        
        const shortKey = image.key.length > 15 ? image.key.substring(0, 12) + '...' : image.key;
        
        // Debug log for first few images
        if (index < 3) {
          console.log(`Image ${index}:`, image.key, image.url);
        }
        
        item.innerHTML = `
          <img src="${image.url}" alt="Gallery image" loading="lazy" 
               onerror="console.error('Failed to load image:', '${image.key}'); this.style.display='none'; this.nextElementSibling.innerHTML='‚ùå Error';">
          <div class="overlay">${shortKey}</div>
        `;
        
        item.addEventListener('click', () => selectImage(image));
        grid.appendChild(item);
      });

      allImagesContainer.innerHTML = '';
      allImagesContainer.appendChild(grid);
    }

    function renderOrderedImages() {
      orderedImagesContainer.innerHTML = '';

      if (!orderedImages.length) {
        orderedImagesContainer.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">No images in gallery yet</div>';
        return;
      }

      orderedImages.forEach((image, index) => {
        const item = document.createElement('div');
        item.className = 'ordered-item';
        item.draggable = true;
        item.dataset.index = index;
        
        const featuredBadge = index < 9 ? ' <span style="color: var(--accent);">[Featured]</span>' : '';
        const shortKey = image.key.length > 25 ? image.key.substring(0, 22) + '...' : image.key;
        
        item.innerHTML = `
          <span class="drag-handle">‚ãÆ‚ãÆ</span>
          <img src="${image.url}" alt="Gallery image">
          <div class="info">
            <div>${shortKey}${featuredBadge}</div>
            <div style="color: var(--muted); font-size: 12px;">Position ${index + 1}</div>
          </div>
          <div class="actions">
            <button class="btn-small" onclick="removeFromGallery(${index})">Remove</button>
          </div>
        `;

        // Add drag events
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('drop', handleDrop);
        item.addEventListener('dragend', handleDragEnd);

        orderedImagesContainer.appendChild(item);
      });
    }

    function renderVetoedImages() {
      vetoedImagesContainer.innerHTML = '';

      if (!vetoedImages.length) {
        vetoedImagesContainer.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">No vetoed images</div>';
        return;
      }

      vetoedImages.forEach((image, index) => {
        const item = document.createElement('div');
        item.className = 'image-item';
        item.innerHTML = `
          <img src="${image.url}" alt="Vetoed image" loading="lazy">
          <div class="overlay" style="background: rgba(239, 68, 68, 0.8);">Vetoed</div>
        `;
        
        item.addEventListener('click', () => restoreFromVeto(image));
        vetoedImagesContainer.appendChild(item);
      });
    }

    function selectImage(image) {
      // Deselect previous
      document.querySelectorAll('.image-item.selected').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Find and select the clicked item
      const allImageItems = document.querySelectorAll('#allImages .image-item');
      allImageItems.forEach(item => {
        const img = item.querySelector('img');
        if (img && img.src === image.url) {
          item.classList.add('selected');
        }
      });
      
      selectedImage = image;
      console.log('Selected image:', image.key);
      
      // Enable action buttons
      const addBtn = document.getElementById('addToGallery');
      const vetoBtn = document.getElementById('vetoImage');
      if (addBtn) addBtn.disabled = false;
      if (vetoBtn) vetoBtn.disabled = false;
    }

    function addToGallery() {
      if (!selectedImage) return;
      
      orderedImages.push(selectedImage);
      selectedImage = null;
      
      // Disable buttons and deselect
      document.getElementById('addToGallery').disabled = true;
      document.getElementById('vetoImage').disabled = true;
      document.querySelectorAll('.image-item.selected').forEach(item => {
        item.classList.remove('selected');
      });
      
      renderAllImages();
      renderOrderedImages();
      updateCounts();
      saveConfig();
      showStatus('Image added to gallery', 'success');
    }

    function vetoImage() {
      if (!selectedImage) return;
      
      vetoedImages.push(selectedImage);
      selectedImage = null;
      
      // Disable buttons and deselect
      document.getElementById('addToGallery').disabled = true;
      document.getElementById('vetoImage').disabled = true;
      document.querySelectorAll('.image-item.selected').forEach(item => {
        item.classList.remove('selected');
      });
      
      renderAllImages();
      renderVetoedImages();
      updateCounts();
      saveConfig();
      showStatus('Image vetoed', 'success');
    }

    function removeFromGallery(index) {
      orderedImages.splice(index, 1);
      renderAllImages();
      renderOrderedImages();
      updateCounts();
      saveConfig();
      showStatus('Image removed from gallery', 'success');
    }

    function restoreFromVeto(image) {
      const index = vetoedImages.findIndex(img => img.key === image.key);
      if (index > -1) {
        vetoedImages.splice(index, 1);
        renderAllImages();
        renderVetoedImages();
        updateCounts();
        saveConfig();
        showStatus('Image restored from veto', 'success');
      }
    }

    function updateCounts() {
      document.getElementById('galleryCount').textContent = `${orderedImages.length} images`;
      document.getElementById('vetoedCount').textContent = `(${vetoedImages.length})`;
    }

    function toggleVetoed() {
      const content = document.getElementById('vetoedContent');
      const toggle = document.getElementById('vetoedToggle');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = '‚ñº';
      } else {
        content.style.display = 'none';
        toggle.textContent = '‚ñ∂';
      }
    }

    function saveConfig() {
      const config = {
        ordered: orderedImages,
        vetoed: vetoedImages,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem('gallery_admin_config', JSON.stringify(config));
    }

    // Drag and drop for reordering
    let draggedElement = null;

    function handleDragStart(e) {
      draggedElement = e.target;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }

    function handleDrop(e) {
      e.preventDefault();
      
      if (draggedElement && draggedElement !== e.target.closest('.ordered-item')) {
        const draggedIndex = parseInt(draggedElement.dataset.index);
        const targetIndex = parseInt(e.target.closest('.ordered-item').dataset.index);
        
        // Reorder array
        const draggedItem = orderedImages[draggedIndex];
        orderedImages.splice(draggedIndex, 1);
        orderedImages.splice(targetIndex, 0, draggedItem);
        
        renderOrderedImages();
        saveConfig(); // Save after reordering
        showStatus('Order updated', 'success');
      }
    }

    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      draggedElement = null;
    }

    // Export/Import functionality
    function exportConfig() {
      const config = {
        metadata: {
          exported: new Date().toISOString(),
          version: "1.0",
          description: "Joey Haley Gallery Configuration"
        },
        gallery: {
          ordered: orderedImages,
          vetoed: vetoedImages.map(img => img.key), // Only store keys for vetoed
          featured_count: 9
        }
      };
      
      const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `joey-haley-gallery-config-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      showStatus('Configuration exported successfully', 'success');
    }

    function importConfig() {
      document.getElementById('configFile').click();
    }

    async function handleConfigImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const config = JSON.parse(text);
        
        if (config.gallery) {
          // Restore ordered images (if they still exist in R2)
          if (config.gallery.ordered) {
            orderedImages = config.gallery.ordered.filter(img => 
              allImages.some(available => available.key === img.key)
            );
          }
          
          // Restore vetoed images (by key reference)
          if (config.gallery.vetoed) {
            vetoedImages = allImages.filter(img => 
              config.gallery.vetoed.includes(img.key)
            );
          }
          
          renderAllImages();
          renderOrderedImages();
          renderVetoedImages();
          updateCounts();
          saveConfig();
          
          showStatus('Configuration imported successfully', 'success');
        } else {
          throw new Error('Invalid configuration format');
        }
      } catch (error) {
        console.error('Import error:', error);
        showStatus('Failed to import configuration', 'error');
      }
      
      event.target.value = ''; // Reset file input
    }

    // Save current state to production
    async function saveOrder() {
      try {
        showStatus('Saving gallery configuration...', 'info');
        
        const orderData = {
          featured: orderedImages.slice(0, 9),
          all: orderedImages,
          vetoed: vetoedImages.map(img => img.key),
          timestamp: new Date().toISOString()
        };
        
        // This would be your actual API call:
        // const response = await fetch('/api/admin/gallery-config', {
        //   method: 'POST',
        //   headers: { 
        //     'Content-Type': 'application/json',
        //     'Authorization': 'Bearer ' + localStorage.getItem(ADMIN_PASSWORD_KEY)
        //   },
        //   body: JSON.stringify(orderData)
        // });
        
        // For development, store locally and show what would be saved
        localStorage.setItem('gallery_production_config', JSON.stringify(orderData));
        
        // Simulate API call delay
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        showStatus('Gallery configuration saved successfully!', 'success');
        console.log('Production config saved:', orderData);
        
      } catch (error) {
        console.error('Failed to save configuration:', error);
        showStatus('Failed to save gallery configuration', 'error');
      }
    }

    function resetOrder() {
      if (confirm('Reset to original order? This will undo all changes.')) {
        loadGalleryData();
        showStatus('Order reset to original', 'info');
      }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      // Event listeners
      authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = document.getElementById('password').value;
        const submitBtn = e.target.querySelector('.btn');
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Authenticating...';
        
        try {
          const success = await authenticate(password);
          if (success) {
            showLoginStatus('Login successful!', 'success');
          } else {
            showLoginStatus('Invalid password', 'error');
          }
        } catch (error) {
          showLoginStatus('Authentication error', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Login';
        }
      });

      // Admin interface buttons (with null checks)
      const saveOrderBtn = document.getElementById('saveOrder');
      const resetOrderBtn = document.getElementById('resetOrder');
      const logoutBtn = document.getElementById('logout');
      const addToGalleryBtn = document.getElementById('addToGallery');
      const vetoImageBtn = document.getElementById('vetoImage');
      const exportConfigBtn = document.getElementById('exportConfig');
      const importConfigBtn = document.getElementById('importConfig');
      const configFileInput = document.getElementById('configFile');

      if (saveOrderBtn) saveOrderBtn.addEventListener('click', saveOrder);
      if (resetOrderBtn) resetOrderBtn.addEventListener('click', resetOrder);
      if (logoutBtn) logoutBtn.addEventListener('click', logout);
      if (addToGalleryBtn) addToGalleryBtn.addEventListener('click', addToGallery);
      if (vetoImageBtn) vetoImageBtn.addEventListener('click', vetoImage);
      if (exportConfigBtn) exportConfigBtn.addEventListener('click', exportConfig);
      if (importConfigBtn) importConfigBtn.addEventListener('click', importConfig);
      if (configFileInput) configFileInput.addEventListener('change', handleConfigImport);

      // Global functions for onclick handlers
      window.removeFromGallery = removeFromGallery;
      window.toggleVetoed = toggleVetoed;

      // Initialize
      checkAuth();
    });
  </script>
</body>
</html>